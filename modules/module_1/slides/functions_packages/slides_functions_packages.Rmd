---
title: "Introduction to R for<br>Applied Epidemiology"
subtitle: "<br>Functions and packages"
author: "March 2022"
date: '[contact@appliedepi.org](mailto:contact@appliedepi.org)'
output:
  xaringan::moon_reader:
    seal: TRUE
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
    css: xaringan-themer.css
params:
  online: TRUE
---

```{r, eval=F, echo=F, include = F}
# Must do in order to render.

pacman::p_load(xaringan)
devtools::install_github("gadenbuie/xaringanExtra")
remotes::install_github("mitchelloharawild/icons")
icons::download_fontawesome()

# Render with xaringan::infinite_moon_reader()
# Slides will appear in viewer, and will update as you edit/save
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      fig.retina = 3  ## retina more effective than w/h (according to twitter)
                      # fig.width = 16, 
                      # fig.height = 10
                      )
## I dont know why this is included in the example xaringan slide 
## but is something to do with background images
options(htmltools.dir.version = FALSE)

## install and load necessary packages 
pacman::p_load(
  rio,        # importing data  
  here,       # relative file pathways  
  janitor,    # data cleaning and tables
  lubridate,  # working with dates
  tidyverse,  # data management and visualization
  gtsummary,  # summary tables
  flair,       # for decorating code chunks with colors
  kableExtra, # for output tables
  xaringanthemer  # for styling presentation 
)
```


```{r  xaringan-themer, include = FALSE}

## define presentation colours (theme) using {xaringanthemer} package 
## https://pkg.garrickadenbuie.com/xaringanthemer/articles/xaringanthemer.html

## epirhandbook logo colours: 
  ## blue: "#00538c"
  ## green: "#007732"
  ## lighter green: "#48a878"

## see ?style_mono_accent for all the things can customise
style_mono_accent(
  base_color = "#00538c", 
  link_color = "#48a878", 
  ## add logo to the title page (bit bigger)
  title_slide_background_image = "https://github.com/appliedepi/intro_course/raw/main/images/logo.png", 
  title_slide_background_position = "95% 95%", 
  title_slide_background_size = "25%", 
  ## add logo to all following slides
  background_image = "https://github.com/appliedepi/intro_course/raw/main/images/logo.png", 
  background_size = "10%",
  background_position = "100% 0%"
)
```

```{css, echo=F}
    .remark-slide table{
      border: none
    }
    .remark-slide-table {
      
    }
    tr:first-child {
      border-top: none;
  }
    tr:last-child {
    border-bottom: none;
  }
```

```{r, echo=F, include = F}
surv_linelist <- rio::import(here::here("data", "surveillance_linelist_12012014.xlsx"))
medical_linelist <- rio::import(here::here("data", "medical_linelist_12012014.xlsx"))

```


# Today: objectives & schedule  

**In this module we aim to help you:**  
* Understand R within the ecosystem of analytical tools  
* Navigate RStudio and R projects  
* Write a basic R script to load packages, import data, and view a dataset  


```{r, echo=FALSE, warning=F, message=F}
outline <- dplyr::tribble(
  ~Time, ~Location, ~Topic,
  "0900-0945",     "Main",      "Welcome, course logistics, Why R?",
  "0950-1050",     "Main",      "Lecture and live demonstration:\nRStudio tour, R projects, basic R syntax, functions & packages, data import",
  "1100-1200",     "Breakouts", "Setting up a script, importing data, and reviewing a data frame",
  "1205-1220",     "Main",      "Debrief"
)

outline %>% 
  flextable::qflextable() %>% 
  flextable::add_footer_lines("Breaks are incorporated above, but not shown as rows")
```


---
class: inverse, center, middle

.pull-left[
## Functions: 
## Tools to help you accomplish a specific task 
]

.pull-right[

```{r, eval = TRUE, echo = FALSE, out.width = "75%"}
# adding xfun::relative_path() creates a dynamic file path between the Rmd location and the here() path.
# It dynamically creates the ../../etc filepath.

knitr::include_graphics(xfun::relative_path(here::here("images", "functions_packages", "function_tools_pliers.png")))
```

]

---
# Functions   
### Inputs and outputs  

- A function is like a machine that:  
     - Receives inputs
     - Does some action with the inputs  
     - Returns an output  

- Functions have a name (*hopefully intuitive!*), and have parentheses ( )  
     * `print()` helps you print an R object
     * `mean()`  averages some values
     * `filter()` removes certain rows in a dataset using logical criteria

.footnote[functions also appear in Excel as *equations*]

---
# Simple functions

.pull-left[

- `sqrt()`  
  * Accepts one numeric value as input, returns the square root

- `max()`  
  * Accepts numeric values and returns the maximum

- `c()`  
  * Shorthand for "concatenate"  
  * Combines inputs into a *vector*  
]

.pull-right[
```{r, echo=T, out.width="100%"}
sqrt(49)
```
<br>
```{r, echo=T, out.width="100%"}
max(2, 10, 15, 200, 9)
```
<br>
```{r, echo=T, out.width="100%"}
c(2, 5, 9, 12, 47)
```
]

.footnote[These are examples of functions in "*base R*" - functions that come installed with R.]

???
Demonstrate each `sqrt(49)`, `sqrt(12)`, `max(1, 15, 2, 9)` (explain commas)
Explain vectors `c(1, 15, 2, 9)` and a named vector `cities <- c("Wuhan", "Milan", "New York")`
Quickly note indexed vectors `cities[[2]]`
and numeric: `ages <- c(15, 28, 100, 15, 65, 4, 10)` then `summary(ages)` and `summary(ages)[2]` and `summary(ages)[[2]]`


---
# Arguments  

.pull-left[


But most functions are not so simple.  

</br>

They must be told *how* to work, and *on what* to work.  

</br>


You specify these values to their **"arguments"**.  

</br>


Arguments are like inputs and settings, with *names* to distinguish them:

]


.pull-right[

```{r, eval = TRUE, echo = FALSE, out.width = "100%"}
# adding xfun::relative_path() creates a dynamic file path between the Rmd location and the here() path.
# It dynamically creates the ../../etc filepath.

knitr::include_graphics(xfun::relative_path(here::here("images", "functions_packages", "arguments-buttons.png")))
```

]





---
# Baking example

--

Let us pretend that `oven_bake()` is a function we are using to bake bread.  
What *arguments* might this function take?

- hint: what *object* needs to be put in the oven? Which *settings* must be adjusted?

--

```{r, eval = TRUE, echo = FALSE, out.width = "100%"}
# Using here() alone won't work because Rmd folder becomes the rendering root.
# adding xfun::relative_path() creates a dynamic file path between the Rmd location and the here() path.
# It dynamically creates the ../../etc filepath.

knitr::include_graphics(xfun::relative_path(here::here("images", "functions_packages", "Function_Bread_Example.png")))
```




---
# Example: tbl_cross()

```{r include=FALSE}
linelist <- surv_linelist
```


```{r, results = "asis", echo = FALSE}
"Let's say we have a dataset in R which we named 'linelist'.\ntbl_cross() needs 3 arguments to create a cross-tabulation:" %>%
  flair("dataset", color = "deeppink") %>%
  flair("tbl_cross()", color = "cornflowerblue") %>%
  flair("dataset", color = "deeppink") %>%
  flair("linelist", color = "deeppink") %>%
  flair("arguments", color = "orange") %>%
  flair("column name", color = "green") %>%
  flair("data =", color = "orange") %>%
  flair("col =", color = "orange") %>%
  flair("row =", color = "orange") %>%
  flair_all(before = "<h4>", after = "</h4>") %>%
  cat()
```


--

```{r function, include = F}
tbl_cross(data = linelist, row = gender, col = case_def)
```

```{r function_flair, echo = FALSE}
decorate("function") %>%
  flair("tbl_cross", color = "cornflowerblue") %>%
  flair("data", color = "orange") %>% 
  flair("row", color = "orange") %>% 
  flair("col", color = "orange") %>% 
  flair("linelist", color = "deeppink") %>% 
  flair("gender", color = "green") %>% 
  flair("case_def", color = "green") %>% 
  knit_print.with_flair()
```




???
gender and case_def are variables in the linelist dataset
The colors have been added in the slides for clarity (they do not appear this way in R)

---






---
# A real R function 

But we do not use R to bake break. Let's see a real example:

The function `age_pyramid()` takes the following arguments:  

Argument        |Expected                
----------------|--------------------
`data = `       |A dataset imported into R to be used for the pyramid
`age_group = `  |A column name in the data of categorical ages (e.g. "10-14")
`split_by = `   |A column name from the data of gender values (e.g. "f")  



---

1. Write the function
2. In the parentheses, you provide values for the function's *arguments*  
3. Unseen, the function's code runs, using the values you have given for its arguments
4. An output is returned  





---
# File paths

#### Use the `{here}` package to find files

.pull-left[
- *Relative* rather than *absolute* file-paths 
  - Better than `setwd()` for sharing
- Finds root directory automatically 
- Open `.Rproj` file first
- package::function() to avoid conflicts
  - `here::here()`
]

.pull-right[
![source: Alison Horst](https://raw.githubusercontent.com/allisonhorst/stats-illustrations/master/rstats-artwork/here.png)
]

 
.footnote[
See the [EpiRHandbook section on here package](https://epirhandbook.com/import-and-export.html?q=here#here)
]

---
# Importing data  
#### Using the `{rio}` package for important data 
- `rio::import()` to import a file
  - wrapper package able to import wide variety of file formats


```{r, eval=FALSE, echo = TRUE}
# import excel file from data folder
# use  sheet named **in**
raw_linelist <- rio::import(
  here::here("data", "covid_linelist.xlsx"), 
  which = "in"
)
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
# import actual data for use in this slide deck
linelist_raw <- rio::import(here::here("data", "linelist_cleaned.rds"))
```

.footnote[

See the [EpiRHandbook section on importing](https://epirhandbook.com/cleaning-data-and-core-functions.html?q=import#import)

]


